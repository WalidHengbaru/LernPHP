<?php
session_name('ADMIN_SESSION');
session_start();
require 'config.php';

// Check if user is logged in and is super_admin or regular_admin
if (!isset($_SESSION['user_id']) || !in_array($_SESSION['admin_level'], ['super_admin', 'regular_admin'])) {
    header("Location: admin_login.php");
    exit;
}

$pdo = new PDO(
    "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4",
    DB_USER,
    DB_PASS,
    [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => false
    ]
);

// Fetch admin data
$stmt = $pdo->prepare("SELECT id, username, email, admin_level, profile_image FROM users WHERE id = ?");
$stmt->execute([$_SESSION['user_id']]);
$admin = $stmt->fetch();

if (!$admin) {
    error_log('Admin not found for user_id: ' . $_SESSION['user_id']);
    echo "<p class='alert alert-error'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</p>";
    exit;
}

$error = '';
$success = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = trim($_POST['username'] ?? '');
    $email = trim($_POST['email'] ?? '');
    $password = trim($_POST['password'] ?? '');

    // Validate inputs
    if ($username === '' || $email === '') {
        $error = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•';
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $error = '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    } else {
        // Check for duplicate username or email (excluding current user)
        $check = $pdo->prepare("SELECT id FROM users WHERE (username = ? OR email = ?) AND id != ?");
        $check->execute([$username, $email, $_SESSION['user_id']]);
        if ($check->fetch()) {
            $error = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß';
        } else {
            // Handle image upload
            $profile_image = $admin['profile_image'] ?? null;
            if (isset($_FILES['profile_image']) && $_FILES['profile_image']['error'] === UPLOAD_ERR_OK) {
                $allowed_types = ['image/jpeg', 'image/png', 'image/gif'];
                $max_size = 2 * 1024 * 1024; // 2MB
                $file = $_FILES['profile_image'];
                if (in_array($file['type'], $allowed_types) && $file['size'] <= $max_size) {
                    $ext = pathinfo($file['name'], PATHINFO_EXTENSION);
                    $filename = 'admin_' . $_SESSION['user_id'] . '_' . time() . '.' . $ext;
                    $upload_dir = 'uploads/';
                    if (!is_dir($upload_dir)) {
                        mkdir($upload_dir, 0755, true);
                    }
                    if (move_uploaded_file($file['tmp_name'], $upload_dir . $filename)) {
                        $profile_image = $upload_dir . $filename;
                    } else {
                        $error = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ';
                    }
                } else {
                    $error = '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô JPEG, PNG, GIF ‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB)';
                }
            }

            if (!$error) {
                // Update user data
                $fields = ['username = :username', 'email = :email'];
                $params = [':username' => $username, ':email' => $email, ':id' => $_SESSION['user_id']];
                if ($password !== '') {
                    $fields[] = 'password = :password';
                    $params[':password'] = password_hash($password, PASSWORD_DEFAULT);
                }
                if ($profile_image !== null) {
                    $fields[] = 'profile_image = :profile_image';
                    $params[':profile_image'] = $profile_image;
                }
                $sql = "UPDATE users SET " . implode(', ', $fields) . " WHERE id = :id";
                try {
                    $stmt = $pdo->prepare($sql);
                    $stmt->execute($params);
                    $success = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                    $_SESSION['username'] = $username;
                    $admin['username'] = $username;
                    $admin['email'] = $email;
                    $admin['profile_image'] = $profile_image;
                } catch (PDOException $e) {
                    $error = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' . htmlspecialchars($e->getMessage());
                }
            }
        }
    }
}
?>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</title>
    <link rel="stylesheet" href="style.css">
    <script>
        function validateForm() {
            const username = document.querySelector('input[name="username"]').value.trim();
            const email = document.querySelector('input[name="email"]').value.trim();
            if (!username || !email) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•');
                return false;
            }
            if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return false;
            }
            return true;
        }
    </script>
</head>
<body>
    <div class="top-bar">
        <div class="user-info">
            ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, <?php echo htmlspecialchars($_SESSION['username']); ?> 
            (<?php echo $_SESSION['admin_level'] === 'super_admin' ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏ç‡πà' : '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏£‡∏≠‡∏á'; ?>)
        </div>
        <a href="logout.php" class="button button-danger">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>
    <div class="container">
        <h2>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h2>
        <?php if ($error): ?>
            <p class="alert alert-error"><?php echo htmlspecialchars($error); ?></p>
        <?php endif; ?>
        <?php if ($success): ?>
            <p class="alert alert-success"><?php echo htmlspecialchars($success); ?></p>
        <?php endif; ?>
        <?php if (empty($admin)): ?>
            <p class="alert alert-error">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÑ‡∏î‡πâ</p>
        <?php else: ?>
            <form method="POST" enctype="multipart/form-data" class="form-container" onsubmit="return validateForm()">
                <?php if (!empty($admin['profile_image'])): ?>
                    <img src="<?php echo htmlspecialchars($admin['profile_image']); ?>" alt="Profile Image" class="profile-image">
                <?php endif; ?>
                <div class="form-group">
                    <label>‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                    <input type="file" name="profile_image" accept="image/jpeg,image/png,image/gif">
                </div>
                <fieldset>
                    <legend>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</legend>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ *</label>
                            <input name="username" value="<?php echo htmlspecialchars($admin['username'] ?? ''); ?>" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏• *</label>
                            <input type="email" name="email" value="<?php echo htmlspecialchars($admin['email'] ?? ''); ?>" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
                            <input type="password" name="password">
                        </div>
                    </div>
                </fieldset>
                <div class="button-container">
                    <button type="submit" class="button button-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button type="reset" class="button button-secondary">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <a href="admin_index.php" class="button button-secondary">‚¨ÖÔ∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
                </div>
            </form>
        <?php endif; ?>
    </div>
</body>
</html>